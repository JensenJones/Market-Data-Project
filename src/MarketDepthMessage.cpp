#include "../include/MarketDepthMessage.hpp"

#include <print>
#include <iostream>
#include <sstream>

#include "OrderFactory.hpp"

/*
 * Example Market Depth Message:
 * {"stream":"btcusdt@depth","data":{"e":"depthUpdate","E":1766977041014,"s":"BTCUSDT","U":84076541514,"u":84076542177,"b":[["89235.99000000","5.24538000"],["89235.62000000","0.00082000"],["89235.49000000","0.00006000"],["89234.88000000","0.00268000"],["89234.60000000","0.00012000"],["89234.59000000","0.04636000"],["89234.50000000","0.00006000"],["89234.24000000","0.00000000"],["89234.23000000","0.00000000"],["89233.87000000","0.00006000"],["89233.86000000","0.00000000"],["89233.85000000","0.00000000"],["89233.77000000","0.00000000"],["89233.76000000","0.00000000"],["89233.55000000","0.00000000"],["89233.31000000","0.00000000"],["89232.76000000","0.00012000"],["89232.75000000","0.12637000"],["89232.74000000","0.37027000"],["89232.73000000","0.00006000"],["89232.64000000","0.00250000"],["89232.40000000","0.00000000"],["89232.39000000","0.00000000"],["89231.86000000","0.00000000"],["89231.84000000","0.00000000"],["89231.83000000","0.00000000"],["89231.54000000","0.00006000"],["89231.53000000","0.11677000"],["89231.25000000","0.00000000"],["89231.24000000","0.00400000"],["89231.14000000","0.00006000"],["89231.02000000","0.00000000"],["89230.49000000","0.45763000"],["89230.48000000","0.50587000"],["89230.47000000","0.00000000"],["89229.85000000","0.00006000"],["89229.81000000","0.02554000"],["89229.74000000","0.00300000"],["89228.41000000","0.18502000"],["89228.40000000","0.00000000"],["89228.25000000","0.00000000"],["89227.66000000","0.40472000"],["89227.65000000","0.22430000"],["89227.13000000","0.17926000"],["89226.20000000","0.00007000"],["89225.34000000","0.04200000"],["89225.33000000","0.00000000"],["89225.08000000","0.50575000"],["89224.87000000","0.00006000"],["89223.54000000","0.06720000"],["89223.06000000","0.42521000"],["89223.05000000","0.00000000"],["89223.04000000","0.00000000"],["89223.03000000","1.34911000"],["89222.61000000","0.00112000"],["89222.59000000","0.07140000"],["89222.08000000","0.00000000"],["89221.32000000","0.00000000"],["89221.19000000","0.00000000"],["89220.85000000","0.00131000"],["89220.67000000","0.01568000"],["89220.37000000","0.00007000"],["89219.93000000","0.00112000"],["89217.69000000","0.00000000"],["89216.74000000","0.00000000"],["89215.62000000","0.02000000"],["89214.94000000","0.00006000"],["89214.55000000","0.05609000"],["89214.50000000","0.05008000"],["89214.41000000","0.00000000"],["89214.11000000","0.00000000"],["89213.69000000","0.00112000"],["89213.61000000","0.00287000"],["89212.89000000","0.00000000"],["89212.12000000","0.00000000"],["89211.68000000","0.00000000"],["89211.00000000","0.00300000"],["89209.22000000","0.00011000"],["89209.09000000","0.00000000"],["89208.30000000","0.00000000"],["89208.22000000","0.00000000"],["89207.28000000","0.81195000"],["89206.54000000","0.71347000"],["89206.25000000","0.00110000"],["89205.83000000","0.79814000"],["89205.41000000","0.02809000"],["89205.31000000","0.00000000"],["89204.29000000","0.00000000"],["89202.60000000","0.00055000"],["89202.15000000","0.40394000"],["89201.43000000","0.04571000"],["89201.35000000","0.00000000"],["89201.18000000","0.21016000"],["89200.99000000","0.00006000"],["89198.04000000","0.00000000"],["89196.26000000","0.00000000"],["89195.83000000","0.05432000"],["89191.16000000","0.00000000"],["89184.06000000","0.00000000"],["89182.45000000","0.08430000"],["89180.57000000","0.17502000"],["89169.50000000","0.00000000"],["89162.31000000","0.00000000"],["89160.53000000","0.06300000"],["89155.68000000","0.00011000"],["89142.73000000","0.00000000"],["89128.91000000","0.00011000"],["89115.96000000","0.00000000"],["89102.14000000","0.00011000"],["89089.20000000","0.00000000"],["89031.77000000","0.00719000"],["89027.06000000","0.00000000"],["88895.08000000","0.27000000"],["88866.14000000","0.00018000"],["87098.44000000","0.00266000"],["86784.19000000","0.00000000"],["80312.40000000","0.00238000"],["80312.00000000","0.00017000"],["80300.00000000","13.61003000"],["71388.80000000","0.00028000"]],"a":[["89236.00000000","0.44141000"],["89236.01000000","0.00129000"],["89236.02000000","0.00033000"],["89236.04000000","0.00018000"],["89236.05000000","0.05021000"],["89236.27000000","0.00006000"],["89236.49000000","0.00018000"],["89236.50000000","0.24978000"],["89236.51000000","0.03316000"],["89236.94000000","0.00000000"],["89237.66000000","0.00000000"],["89237.67000000","0.00000000"],["89237.69000000","0.00018000"],["89237.70000000","0.37025000"],["89237.98000000","0.00000000"],["89238.01000000","0.25946000"],["89238.05000000","0.00000000"],["89238.06000000","0.00000000"],["89238.10000000","0.00000000"],["89238.17000000","0.00000000"],["89238.46000000","0.00006000"],["89238.47000000","0.00006000"],["89238.69000000","0.00000000"],["89238.87000000","0.00000000"],["89238.88000000","0.04647000"],["89239.28000000","0.00000000"],["89239.29000000","0.00000000"],["89239.43000000","0.00000000"],["89239.44000000","0.00000000"],["89239.82000000","0.00006000"],["89239.94000000","0.00000000"],["89239.96000000","0.00006000"],["89240.43000000","0.00000000"],["89240.64000000","0.01333000"],["89240.65000000","0.00006000"],["89240.66000000","0.00006000"],["89240.83000000","0.00000000"],["89241.06000000","0.02554000"],["89241.81000000","0.00000000"],["89242.17000000","0.00006000"],["89243.03000000","0.00006000"],["89243.04000000","0.01512000"],["89243.43000000","0.00000000"],["89243.59000000","0.00000000"],["89244.36000000","0.00006000"],["89245.13000000","0.00000000"],["89245.14000000","0.07110000"],["89245.29000000","0.00000000"],["89245.30000000","0.11212000"],["89245.70000000","0.00051000"],["89245.87000000","0.01117000"],["89246.07000000","0.00000000"],["89246.08000000","0.00256000"],["89246.24000000","0.00117000"],["89246.42000000","0.00076000"],["89247.29000000","0.00194000"],["89247.36000000","0.00006000"],["89247.37000000","0.00048000"],["89247.98000000","0.00048000"],["89248.03000000","0.00300000"],["89248.32000000","0.00250000"],["89248.38000000","0.10249000"],["89248.49000000","0.00056000"],["89249.09000000","0.00000000"],["89249.10000000","0.00000000"],["89249.63000000","0.00000000"],["89249.66000000","0.00000000"],["89249.67000000","0.00000000"],["89249.81000000","0.00000000"],["89249.89000000","0.00000000"],["89250.11000000","0.00000000"],["89250.12000000","0.00000000"],["89250.14000000","0.03363000"],["89250.18000000","0.06262000"],["89252.00000000","0.00100000"],["89253.88000000","0.33887000"],["89254.00000000","0.00100000"],["89254.38000000","0.17926000"],["89254.74000000","0.00300000"],["89254.87000000","0.00006000"],["89255.29000000","0.17923000"],["89256.00000000","0.00100000"],["89257.28000000","0.00000000"],["89258.00000000","0.00100000"],["89258.42000000","0.00287000"],["89259.52000000","0.00000000"],["89260.00000000","0.00100000"],["89260.13000000","0.00000000"],["89260.22000000","0.05631000"],["89260.87000000","0.00000000"],["89260.99000000","0.00300000"],["89262.00000000","0.00100000"],["89262.77000000","0.00011000"],["89264.00000000","0.00100000"],["89264.92000000","0.05474000"],["89271.00000000","0.00006000"],["89276.15000000","0.00112000"],["89276.57000000","0.00000000"],["89289.54000000","0.00011000"],["89293.04000000","0.00000000"],["89300.12000000","0.00672000"],["89303.34000000","0.00000000"],["89316.31000000","0.00011000"],["89320.52000000","0.00000000"],["89330.11000000","0.00000000"],["89343.08000000","0.00011000"],["89356.87000000","0.00000000"],["89363.84000000","0.01755000"],["89365.80000000","0.00000000"],["89369.85000000","0.00011000"],["89372.20000000","0.00006000"],["89496.90000000","0.00012000"],["89500.00000000","32.37791000"],["89501.36000000","0.00000000"],["89690.66000000","0.00265000"]]}}
 */

std::vector<std::string> MarketDepthMessage::splitStringOnDelim(const std::string &s, const char delim) {
    std::vector<std::string> parts;
    std::stringstream ss(s);
    std::string item;

    while (std::getline(ss, item, delim)) {
        parts.push_back(item);
    }

    return parts;
}

enum class ReadingState {
    PRE,
    BID,
    ASK,
};

MarketDepthMessage::MarketDepthMessage(const std::string &message) {
    ReadingState state = ReadingState::PRE;

    auto messageParts = splitStringOnDelim(message, '"');
    OrderFactory orderFactory;

    for (std::string& part : messageParts) {
        if (state == ReadingState::PRE) {
            if (part != "b") {
                continue;
            }
            state = ReadingState::BID;
        }

        if (std::isdigit(part[0])) {
            if (auto order = orderFactory.newData(std::stod(part))) {
                state == ReadingState::BID ? bids.push_back(order.value()) : asks.push_back(order.value());
            }
        } else if (part == "a") {
            state = ReadingState::ASK;
        }
    }
}

void MarketDepthMessage::printMarketDepth() {
    std::println(std::cout, "Bids:");
    printVec(bids);
    std::println(std::cout, "\nAsks:");
    printVec(asks);
}

void printVec(std::vector<Order>& orders) {
    for (Order& order : orders) {
        printf("%f | %f\n", order.getPrice(), order.getQuantity());
    }
    std::println();
}
